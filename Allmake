#!/usr/bin/env bash

if [ -z "$WM_PROJECT" ]; then
  echo "OpenFOAM environment not found, forgot to source the OpenFOAM bashrc?"
  exit 1
fi

function makeDAFoam()
{ 
  export WM_QUIET=true
  # the script will exit if there is any error
  set -e
  wmakeLnInclude src/adjoint
  cd src/adjoint && wmake -j && cd -
  #cd src/newTurbModels && ./Allmake && cd -
  cd src/pyUnitTests && ./Allmake && cd -
  #cd src/pyDASolvers && ./Allmake && cd -
  #cd src/utilities/preProcessing && ./Allmake && cd -
  # disable the -e flag
  set +e
}

# compile original mode
echo "***************** Compiling original mode **************"
. $DAFOAM_ROOT_PATH/loadDAFoam.sh
makeDAFoam
# if we set COMPILE_DAFOAM_NOAD, we can skip the compilation of AD modes
if [ -z "$COMPILE_DAFOAM_NOAD" ]; then
  # compile ADR mode
  echo "***************** Compiling ADR mode **************"
  . $DAFOAM_ROOT_PATH/loadDAFoam.sh
  sed -i 's/export WM_AD_MODE=.*/export WM_AD_MODE=ADR/' $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-AD/etc/bashrc
  . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-AD/etc/bashrc
  makeDAFoam
  # if COMPILE_DAFOAM_ADF is set, compile ADF mode
  if [ -z "$COMPILE_DAFOAM_ADF" ]; then
    echo "COMPILE_DAFOAM_ADF is not set. skip the ADF mode"
  else
    echo "***************** Compiling ADF mode **************"
    . $DAFOAM_ROOT_PATH/loadDAFoam.sh
    sed -i 's/export WM_AD_MODE=.*/export WM_AD_MODE=ADF/' $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-AD/etc/bashrc
    . $DAFOAM_ROOT_PATH/OpenFOAM/OpenFOAM-AD/etc/bashrc
    makeDAFoam
  fi
fi
# reset the OpenFOAM environment to the original mode
. $DAFOAM_ROOT_PATH/loadDAFoam.sh

pip install .

ls -R dafoam/libs && echo " " && echo "*** Build Successful! ***" && echo " "