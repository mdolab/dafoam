#!/usr/bin/env bash

if [ -z "$WM_PROJECT" ]; then
  echo "OpenFOAM environment not found, forgot to source the OpenFOAM bashrc?"
  exit 1
fi

# check if we need to download input.tar.gz
if [ -f "input.tar.gz" ]; then
  echo "input.tar.gz already exists."
else
  echo "Downloading input.tar.gz"
  wget https://github.com/dafoam/files/releases/download/v1.0.0/input.tar.gz --no-check-certificate
fi

# test DASimpleFoam
rm -rf input DAFoam_Test_DASimpleFoam.txt
tar -zxf input.tar.gz
mpirun -np 4 python runTests_DASimpleFoam.py 2>&1 | tee DAFoam_Test_DASimpleFoam.txt
python testFuncs.py refs/DAFoam_Test_DASimpleFoamRef.txt DAFoam_Test_DASimpleFoam.txt || exit 1
echo "DASimpleFoam: Success!"

# test DARhoSimpleFoam
rm -rf input DAFoam_Test_DARhoSimpleFoam.txt
tar -zxf input.tar.gz
mpirun -np 4 python runTests_DARhoSimpleFoam.py 2>&1 | tee DAFoam_Test_DARhoSimpleFoam.txt
python testFuncs.py refs/DAFoam_Test_DARhoSimpleFoamRef.txt DAFoam_Test_DARhoSimpleFoam.txt || exit 1
echo "DARhoSimpleFoam: Success!"

# test DARhoSimpleCFoam
rm -rf input DAFoam_Test_DARhoSimpleCFoam.txt
tar -zxf input.tar.gz
mpirun -np 4 python runTests_DARhoSimpleCFoam.py 2>&1 | tee DAFoam_Test_DARhoSimpleCFoam.txt
python testFuncs.py refs/DAFoam_Test_DARhoSimpleCFoamRef.txt DAFoam_Test_DARhoSimpleCFoam.txt || exit 1
echo "DARhoSimpleCFoam: Success!"

echo " "
echo "************************************************************"
echo "**************** All DAFoam tests passed! ******************"
echo "************************************************************"
echo " "
